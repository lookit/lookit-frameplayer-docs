<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/mixins/expand-assets.js - ember-lookit-frameplayer</title>
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="https://yui-s.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="https://yui-s.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">
<div id="doc">
    <div id="bd" class="yui3-g">
        <div class="yui3-u-1-5">
            <div id="docs-sidebar" class="sidebar apidocs">
              <h2 style="display:inline;">
              <div>
                <img style="float:right; vertical-align:middle;" src="../assets/css/logo.png" height="70">
                <span>Lookit<br> component<br> docs</span>

                    <p>Version: latest <br>(v1.2.0)</p>
                    <select name="select_version" onchange="location = this.value;">
                        <option value="">--Select different version--</option>
                            <option value="releases/v1.2.0/">v1.2.0</option>
                    </select>
              </div>

              </h2>


              <div id="api-list">
                  <div id="api-tabview">
              
                    <div id="api-tabview-panel">
                        <h2 class="off-left">Collections</h2>
                        <ul id="api-modules" class="apis modules">
                            <li class="module-sidebar-exp-player"><a href="../modules/exp-player.html">exp-player</a></li>
                            <li class="module-sidebar-frames"><a href="../modules/frames.html">frames</a></li>
                            <li class="module-sidebar-mixins"><a href="../modules/mixins.html">mixins</a></li>
                            <li class="module-sidebar-randomizers"><a href="../modules/randomizers.html">randomizers</a></li>
                        </ul>
                        <h2 class="off-left">All elements</h2>
                              <div id="api-tabview-filter">
                      <input type="search" id="api-filter" placeholder="Type to filter">
                    </div>
                        <ul id="api-classes" class="apis classes">
                            <li><a href="../classes/Exp-frame-base.html">Exp-frame-base</a></li>
                            <li><a href="../classes/Exp-frame-select.html">Exp-frame-select</a></li>
                            <li><a href="../classes/Exp-lookit-calibration.html">Exp-lookit-calibration</a></li>
                            <li><a href="../classes/Exp-lookit-change-detection.html">Exp-lookit-change-detection</a></li>
                            <li><a href="../classes/Exp-lookit-composite-video-trial.html">Exp-lookit-composite-video-trial</a></li>
                            <li><a href="../classes/Exp-lookit-dialogue-page.html">Exp-lookit-dialogue-page</a></li>
                            <li><a href="../classes/Exp-lookit-exit-survey.html">Exp-lookit-exit-survey</a></li>
                            <li><a href="../classes/Exp-lookit-geometry-alternation.html">Exp-lookit-geometry-alternation</a></li>
                            <li><a href="../classes/Exp-lookit-geometry-alternation-open.html">Exp-lookit-geometry-alternation-open</a></li>
                            <li><a href="../classes/Exp-lookit-images-audio.html">Exp-lookit-images-audio</a></li>
                            <li><a href="../classes/Exp-lookit-instructions.html">Exp-lookit-instructions</a></li>
                            <li><a href="../classes/Exp-lookit-mood-questionnaire.html">Exp-lookit-mood-questionnaire</a></li>
                            <li><a href="../classes/Exp-lookit-observation.html">Exp-lookit-observation</a></li>
                            <li><a href="../classes/Exp-lookit-preferential-looking.html">Exp-lookit-preferential-looking</a></li>
                            <li><a href="../classes/Exp-lookit-stimuli-preview.html">Exp-lookit-stimuli-preview</a></li>
                            <li><a href="../classes/Exp-lookit-story-page.html">Exp-lookit-story-page</a></li>
                            <li><a href="../classes/Exp-lookit-survey.html">Exp-lookit-survey</a></li>
                            <li><a href="../classes/Exp-lookit-text.html">Exp-lookit-text</a></li>
                            <li><a href="../classes/Exp-lookit-video.html">Exp-lookit-video</a></li>
                            <li><a href="../classes/Exp-lookit-video-assent.html">Exp-lookit-video-assent</a></li>
                            <li><a href="../classes/Exp-lookit-video-consent.html">Exp-lookit-video-consent</a></li>
                            <li><a href="../classes/Exp-lookit-webcam-display.html">Exp-lookit-webcam-display</a></li>
                            <li><a href="../classes/Exp-video-config.html">Exp-video-config</a></li>
                            <li><a href="../classes/Exp-video-config-quality.html">Exp-video-config-quality</a></li>
                            <li><a href="../classes/Expand-assets.html">Expand-assets</a></li>
                            <li><a href="../classes/Full-screen.html">Full-screen</a></li>
                            <li><a href="../classes/Media-reload.html">Media-reload</a></li>
                            <li><a href="../classes/Permute.html">Permute</a></li>
                            <li><a href="../classes/Random-parameter-set.html">Random-parameter-set</a></li>
                            <li><a href="../classes/Select.html">Select</a></li>
                            <li><a href="../classes/Session-record.html">Session-record</a></li>
                            <li><a href="../classes/Video-record.html">Video-record</a></li>
                            <li><a href="../classes/video-recorder.html">video-recorder</a></li>
                        </ul>
                    </div>
              
                  </div>
              </div>
            </div>
        </div>
        <div class="yui3-u-4-5">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: app/mixins/expand-assets.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
import Ember from &#x27;ember&#x27;;

/**
 * @module exp-player
 * @submodule mixins
 */

/**
 *
 * Reference for DEVELOPERS of new frames only!
 *
 * Mixin to allow users to provide audio/video and image source values as either relative paths
 * within a base directory or as full paths.
 *
 * When adding this mixin to a frame, you will need to define a property of the frame
 * &#x60;assetsToExpand&#x60;, which indicates which parameters might be source objects that need
 * expansion. &#x60;assetsToExpand&#x60; should be an object with keys &#x60;image&#x60;, &#x60;video&#x60;, and &#x60;audio&#x60;,
 * and each value should be an Array of parameter names that provide sources for resources
 * of the corresponding type. E.g.,
 &#x60;&#x60;&#x60;
    {
        &#x27;image&#x27;: [&#x27;leftObjectPic&#x27;, &#x27;rightObjectPic&#x27;],
        &#x27;audio&#x27;: [&#x27;introAudio&#x27;, &#x27;testAudio&#x27;],
        &#x27;video&#x27;: [&#x27;objectDemoVideo&#x27;]
    }
 &#x60;&#x60;&#x60;
 *
 * This is defined directly within your frame, e.g.:
&#x60;&#x60;&#x60;
    export default ExpFrameBaseComponent.extend(ExpandAssets, {
        ...
        type: &#x27;exp-my-cool-frame&#x27;,
        assetsToExpand:     {
            &#x27;image&#x27;: [&#x27;leftObjectPic&#x27;, &#x27;rightObjectPic&#x27;],
            &#x27;audio&#x27;: [&#x27;introAudio&#x27;, &#x27;testAudio&#x27;],
            &#x27;video&#x27;: [&#x27;objectDemoVideo&#x27;]
            },
        ...,
        meta: {...},
        actions: {...}
    });
&#x60;&#x60;&#x60;

 *
 *
 * The *user* of your frame can then optionally provide &#x60;baseDir&#x60;, &#x60;audioTypes&#x60;, and
 * &#x60;videoTypes&#x60; parameters to indicate how to expand relative paths.
 *
 * How expansion works:
 * - **Images**: Suppose the list &#x60;assetsToExpand[&#x27;image&#x27;]&#x60; contains &#x60;centerStimulus&#x60;. If
 *   &#x60;centerStimulus&#x60; is provided as a full URL (with &#x60;://&#x60; in it), nothing will happen to
 *   it. But if &#x60;centerStimulus&#x60; is a string that is not a full URL, it will be transformed
 *   during the &#x60;didReceiveAttrs&#x60; hook to &#x60;baseDir + &#x27;img/&#x27; + centerStimulus&#x60;.
 *
 * - **Audio**: Suppose the list &#x60;assetsToExpand[&#x27;audio&#x27;]&#x60; contains &#x60;utterance1&#x60;. If
 *   &#x60;utterance1&#x60; is a nonempty string (rather than an object/Array), e.g., &#x60;goodmorning&#x60;,
 *   and &#x60;audioTypes&#x60; has been set to &#x60;[&#x27;typeA&#x27;, &#x27;typeB&#x27;]&#x60;,
 *   then &#x60;utterance1&#x60; will be expanded out to
 &#x60;&#x60;&#x60;
         [
             {
                 src: &#x27;baseDir&#x27; + &#x27;typeA/goodmorning.typeA&#x27;,
                 type: &#x27;audio/typeA&#x27;
             },
             {
                 src: &#x27;baseDir&#x27; + &#x27;typeB/goodmorning.typeB&#x27;,
                 type: &#x27;audio/typeB&#x27;
             }
         ]
 &#x60;&#x60;&#x60;
 *
 * - **Video**: Same as audio, but using the types from &#x60;videoTypes&#x60;.
 *
 * **Important**: During the &#x60;didReceiveAttrs&#x60; hook, your frame will acquire new properties &#x60;[parameterName]_parsed&#x60;
 * for each of the parameters named in &#x60;assetsToExpand&#x60;. These properties will hold the
 * expanded values. E.g., in the example above, you would now have a &#x60;centerStimulus_parsed&#x60;
 * property. This is what you should use for showing/playing images/audio/video in your
 * frame template.
 *
 * **Advanced use**: the property names in &#x60;assetsToExpand&#x60; can be either full parameter names
 * as in the examples above, or can be of the form &#x60;parameterName/subProperty&#x60;. If using
 * the &#x60;parameterName/subProperty&#x60; syntax, instead of processing the parameter &#x60;parameterName&#x60;,
 * we will expect that that parameter is either an object with property &#x60;subProperty&#x60;
 * (which will be expanded) or an Array of objects with property &#x60;subProperty&#x60; (which will
 * be expanded). The original value of the &#x60;parameterName&#x60; parameter may in this case be
 * mutated as assets are expanded. However, your frame will still also acquire a new
 * property &#x60;[parameterName]_parsed&#x60; which you should use for accessing the processed
 * values. This avoids potential problems with the template being rendered using the original
 * values and not updated.
 *
 * @class Expand-assets
 */

var expandAssetsMixin = Ember.Mixin.create({
    /**
     * Object describing which properties may need expansion
     * @property {String} assetsToExpand
     * @private
     */
    assetsToExpand: {},

    frameSchemaProperties: {
        /**
         * Base directory for where to find stimuli. Any image src
         * values that are not full paths will be expanded by prefixing
         * with &#x60;baseDir&#x60; + &#x60;img/&#x60;. Any audio/video src values provided as
         * strings rather than objects with &#x60;src&#x60; and &#x60;type&#x60; will be
         * expanded out to &#x60;baseDir/avtype/[stub].avtype&#x60;, where the potential
         * avtypes are given by &#x60;audioTypes&#x60; and &#x60;videoTypes&#x60;.
         *
         * baseDir should include a trailing slash
         * (e.g., &#x60;http://stimuli.org/myexperiment/&#x60;); if a value is provided that
         * does not end in a slash, one will be added.
         *
         * @property {String} baseDir
         * @default &#x27;&#x27;
         */
        baseDir: {
            type: &#x27;string&#x27;,
            default: &#x27;&#x27;,
            description: &#x27;Base directory for all stimuli&#x27;
        },
        /**
         * List of audio types to expect for any audio specified just
         * with a string rather than with a list of src/type objects.
         * If audioTypes is &#x60;[&#x27;typeA&#x27;, &#x27;typeB&#x27;]&#x60; and an audio source
         * is given as &#x60;intro&#x60;, the audio source will be
         * expanded out to
         *
         *
         *     [
         *         {
         *             src: &#x27;baseDir&#x27; + &#x27;typeA/intro.typeA&#x27;,
         *             type: &#x27;audio/typeA&#x27;
         *         },
         *         {
         *             src: &#x27;baseDir&#x27; + &#x27;typeB/intro.typeB&#x27;,
         *             type: &#x27;audio/typeB&#x27;
         *         }
         *     ]
         *
         *
         * @property {String[]} audioTypes
         * @default [&#x27;mp3&#x27;, &#x27;ogg&#x27;]
         */
        audioTypes: {
            type: &#x27;array&#x27;,
            default: [&#x27;mp3&#x27;, &#x27;ogg&#x27;],
            description: &#x27;List of audio types to expect for any audio sources specified as strings rather than lists of src/type pairs&#x27;
        },
        /**
         * List of video types to expect for any audio specified just
         * with a string rather than with a list of src/type objects.
         * If videoTypes is &#x60;[&#x27;typeA&#x27;, &#x27;typeB&#x27;]&#x60; and a video source
         * is given as &#x60;intro&#x60;, the video source will be
         * expanded out to
         *
         *
         *     [
         *         {
         *             src: &#x27;baseDir&#x27; + &#x27;typeA/intro.typeA&#x27;,
         *             type: &#x27;video/typeA&#x27;
         *         },
         *         {
         *             src: &#x27;baseDir&#x27; + &#x27;typeB/intro.typeB&#x27;,
         *             type: &#x27;video/typeB&#x27;
         *         }
         *     ]
         *
         *
         * @property {String[]} videoTypes
         * @default [&#x27;mp4&#x27;, &#x27;webm&#x27;]
         */
        videoTypes: {
            type: &#x27;array&#x27;,
            default: [&#x27;mp4&#x27;, &#x27;webm&#x27;],
            description: &#x27;List of audio types to expect for any video sources specified as strings rather than lists of src/type pairs&#x27;
        }
    },

    checkFileExists(url) {
        // see https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch
        //
        // Getting back a meaningful response about whether the file even exists requires
        // CORS settings on the server to allow this origin, which is *not* required for
        // simply loading the image/video/audio in the browser, which is all we really
        // need to do. This function will warn if CORS blocks the request or if the file
        // is not available, but this will cause a lot of (unnecessary) noise in many cases.

        // Could alternately try to load assets into browser to see if they exist, but
        // in cases where there are a bunch of potential assets listed, we don&#x27;t necessarily
        // want to load them all upfront.
        fetch(url, { method: &#x27;HEAD&#x27; }).then((response) =&gt; {
            if (!response.ok) {
                console.warn(&#x27;File not available: &#x27;, url);
                console.log(response);
            }
        })
            .catch((error) =&gt; {
                console.warn(&#x27;File not available: &#x27;, url, &#x27; - error: &#x27;, error);
            });
    },

    // Utility to expand stubs into either full URLs (for images) or
    // array of {src: &#x27;url&#x27;, type: &#x27;MIMEtype&#x27;} objects (for audio/video).
    expandAsset(asset, type) {
        var fullAsset = asset;
        var _this = this;

        var typesDict = {
            &#x27;audio&#x27;: this.get(&#x27;audioTypes&#x27;),
            &#x27;video&#x27;: this.get(&#x27;videoTypes&#x27;)
        };

        switch (type) {
        case &#x27;image&#x27;:
            if (typeof asset === &#x27;string&#x27; &amp;&amp; !(asset.includes(&#x27;://&#x27;))) {
                // Image: replace stub with full URL if needed
                fullAsset = this.baseDir + &#x27;img/&#x27; + asset;
            } else if (Array.isArray(asset)) {
                for (var i = 0; i &lt; asset.length; i++) {
                    var currentVal = asset[i];
                    if (typeof currentVal === &#x27;string&#x27; &amp;&amp; !(currentVal.includes(&#x27;://&#x27;))) {
                        asset[i] = this.baseDir + &#x27;img/&#x27; + currentVal;
                    }
                }
            }
            return fullAsset;
        case &#x27;audio&#x27;:
        case &#x27;video&#x27;:
            var types = typesDict[type];
            // Replace any string sources with the appropriate expanded source objects
            if (typeof asset === &#x27;string&#x27; &amp;&amp; asset) {
                fullAsset = [];
                for (var iType = 0; iType &lt; types.length; iType++) {
                    let url = _this.baseDir + types[iType] + &#x27;/&#x27; + asset + &#x27;.&#x27; + types[iType];
                    fullAsset.push({
                        src: url,
                        type: type + &#x27;/&#x27; + types[iType]
                    });
                }
            }
            return fullAsset;
        default:
            throw &quot;Unrecognized type of asset to expand. Options are &#x27;image&#x27;, &#x27;audio&#x27;, and &#x27;video&#x27;.&quot;;
        }
    },

    expandAssets() {
        // Add a trailing slash to baseDir if needed
        var baseDir = this.get(&#x27;baseDir&#x27;);
        if (baseDir &amp;&amp; baseDir.slice(-1) != &#x27;/&#x27;) {
            baseDir = baseDir + &#x27;/&#x27;;
            this.set(&#x27;baseDir&#x27;, baseDir);
        }

        var _this = this;
        var assetTypes = [&#x27;audio&#x27;, &#x27;video&#x27;, &#x27;image&#x27;];
        var sources;

        assetTypes.forEach((type) =&gt; {
            if (_this.get(&#x27;assetsToExpand&#x27;, {}).hasOwnProperty(type)) {
                var srcParameterNames = _this.get(&#x27;assetsToExpand&#x27;, {})[type];
                srcParameterNames.forEach((paraName) =&gt; {
                    var paraPieces = paraName.split(&#x27;/&#x27;);
                    if (paraPieces.length == 1) { // If we have the full parameter name, just expand that param
                        sources = _this.get(paraName);
                        if (sources) {
                            _this.set(paraName + &#x27;_parsed&#x27;, _this.expandAsset(sources, type));
                        }
                    } else if (paraPieces.length == 2) { // If we have something of the form parameterName/propName
                        var baseName = paraPieces[0];
                        var propName = paraPieces[1]; //paraPieces.slice(1,).join(&#x27;/&#x27;);
                        sources = _this.get(baseName, {});
                        if (sources) {
                            if (Array.isArray(sources)) {  //expand this[parameterName][i][propName] for all i
                                sources.forEach((elem) =&gt; {
                                    if (elem.hasOwnProperty(propName)) {
                                        Ember.set(elem, propName, _this.expandAsset(elem[propName], type));
                                    }
                                });
                                _this.set(baseName + &#x27;_parsed&#x27;, sources);
                            } else { //expand this[parameterName][propName]
                                if (sources.hasOwnProperty(propName)) {
                                    Ember.set(sources, propName, _this.expandAsset(sources[propName], type));
                                }
                                _this.set(baseName + &#x27;_parsed&#x27;, sources);
                            }
                        }
                    } else { // Have something like &#x27;a/b/c&#x27; with two or more slashes, not handled yet
                        throw &#x27;Nesting of parameter names to expand beyond two levels not supported (max one slash).&#x27;;
                    }

                });
            }
        });
    },

    didReceiveAttrs() {
        this._super(...arguments);
        this.expandAssets();
    }

});

// JSON Schema values to use for media assets when using this mixin
var audioTypes = [&#x27;mp3&#x27;, &#x27;ogg&#x27;, &#x27;wav&#x27;, &#x27;wave&#x27;, &#x27;x-wav&#x27;, &#x27;x-pn-wav&#x27;, &#x27;webm&#x27;, &#x27;mpeg&#x27;, &#x27;flac&#x27;, &#x27;x-flac&#x27;].map(type =&gt; &#x27;audio/&#x27; + type);
var videoTypes = [&#x27;webm&#x27;, &#x27;mp4&#x27;, &#x27;ogg&#x27;].map(type =&gt; &#x27;video/&#x27; + type);
var schemaForSrcTypePairs = function(types) {
    return {
        type: &#x27;array&#x27;,
        items: {
            type: &#x27;object&#x27;,
            properties: {
                &#x27;src&#x27;: {
                    type: &#x27;string&#x27;,
                    format: &#x27;uri&#x27;
                },
                &#x27;type&#x27;: {
                    type: &#x27;string&#x27;,
                    enum: types
                }
            }
        }
    };
};

var audioAssetOptions = [
    {
        type: &#x27;string&#x27;
    },
    schemaForSrcTypePairs(audioTypes)
];

var videoAssetOptions = [
    {
        type: &#x27;string&#x27;
    },
    schemaForSrcTypePairs(videoTypes)
];

var imageAssetOptions = [
    {
        type: &#x27;string&#x27;
    },
    {
        type: &#x27;string&#x27;,
        format: &#x27;uri&#x27;
    }
];

export default expandAssetsMixin;

export { expandAssetsMixin, audioAssetOptions, videoAssetOptions, imageAssetOptions };

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
